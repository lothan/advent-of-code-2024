use std::fs::read_to_string;
use regex::Regex;

const h : i64 = 103;
const w : i64 = 101;

// const h : i64 = 7;
// const w : i64 = 11;

#[derive(Debug)]
struct Robot {
    p: Point,
    v: Point,
}

#[derive(Debug,Clone,Copy)]
struct Point {
    x: i64,
    y: i64,
}

impl Point {
    fn add(&self, a: Point) -> Point {
        Point { x: self.x + a.x, y: self.y + a.y } 
    }
}

impl Robot {
    fn go(&mut self) {
        self.p = self.p.add(self.v);
        if self.p.x >= w { self.p.x -= w }
        if self.p.y >= h { self.p.y -= h }
        if self.p.x < 0 { self.p.x += w }
        if self.p.y < 0 { self.p.y += h }
    }
    
}

fn read_input(input: &str) -> Vec<Robot> {
    // let are = Regex::new(r"Button A: X\+(\d+), Y\+(\d+)").unwrap();
    // if let Some(cap) = are.captures(line) {
    //     a = (cap.get(1).unwrap().as_str().parse().unwrap(),
    //          cap.get(2).unwrap().as_str().parse().unwrap());
        
    // }
    
    let mut ret = vec![];
    let re = Regex::new(r"p=(?<px>\d+),(?<py>\d+) v=(?<vx>-?\d+),(?<vy>-?\d+)").unwrap();
    for line in input.lines() {
        let Some(c) = re.captures(line) else { panic!("Shoot!") };
        ret.push(Robot { p: Point { x: c["px"].parse().unwrap(),
                                    y: c["py"].parse().unwrap()},
                         v: Point { x: c["vx"].parse().unwrap(),
                                    y: c["vy"].parse().unwrap()}})
    }

    ret
}

pub fn solve() {
    let input = read_to_string("input/14.txt").unwrap();
    println!("part 1: {}", part1(&input));
    println!("part 2: {}", part2(&input));
}

fn part1(input: &str) -> i32 {
    let mut robots = read_input(input);
    for robot in &robots { println!("{robot:?}"); }
    for _ in 0..100 {
        for robot in &mut robots {
            robot.go();
        }
    }
    
    println!("After");
    for robot in &robots { println!("{robot:?}"); }

    let (mut nw, mut ne, mut sw, mut se) = (0, 0, 0, 0);
    for r in &robots {
        if r.p.x < w / 2 && r.p.y < h / 2 { nw += 1 }
        if r.p.x < w / 2 && r.p.y > h / 2 { sw += 1 }
        if r.p.x > w / 2 && r.p.y < h / 2 { ne += 1 }
        if r.p.x > w / 2 && r.p.y > h / 2 { se += 1 }
        
    }
    println!("ne {ne} nw {nw} se {se} sw {sw}");
    nw * ne * sw * se
}

fn part2(input: &str) -> i32 {
    let mut robots = read_input(input);
    for robot in &robots { println!("{robot:?}"); }
    for sec in 0..10000 {
        println!("Second {sec}");
        for robot in &mut robots {
            robot.go();
        }
        // assume the christmas tree has 15 robots in a row
        let mut pos = false;
        for i in 0..h {
            let mut count = 0;
            for j in 0..w {
                let mut occ = false;
                for r in &robots {
                    occ |= i == r.p.y && j == r.p.x;
                }
                if occ { count += 1 } else { count = 0 }
                if count > 15 {
                    pos = true;
                    break;
                }
            }
        }

        if pos {
            for i in 0..h {
                for j in 0..w {
                    let mut occ = false;
                    for r in &robots {
                        occ |= i == r.p.y && j == r.p.x;
                    }
                    if occ { print!("X") } else { print!(".") }
                }
                println!("");
            }
            return sec
        }

        // it does!
        /*
Second 7054
...............X.....X...............X.........................................X.....................
.........................X....................................X.................................X....
...................................................................X.................................
.......................................X.............................................................
...................................................................................................X.
..................X..................................................................................
.........................X...........................................................................
.....................................................................................................
.....................................................................................................
...........................................X..............X..........................................
..............................X....................................................................X.
.................X...................................................................................
.....................................................................................................
.....................................................................................................
............................................................................X........................
.....................................................................................................
.....................................................................................................
.........................................X........X.................................................X
...........................X...X...............................................X.....................
.....................................................................................................
..........X..........................................................................................
.......................X......X...................X..................................................
...................................................................................X....X............
...............................X..X..................................................................
.....................................................................................................
........X..............XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX...............................................
.................X.....X.............................X...............................................
.......................X.............................X..................................X............
...................X...X.............................X...............................................
.......................X.............................X...............................................
.......................X..............X..............X.........X.....................................
.......................X.............XXX.............X...............................................
...X...................X............XXXXX............X.X.............................................
.......................X...........XXXXXXX...........X...............................................
.......................X..........XXXXXXXXX..........X..........................X....................
.......................X............XXXXX............X..................X............................
..X......X...X.........X...........XXXXXXX...........X..............X........................X.X.....
.......................X..........XXXXXXXXX..........X...............................................
.......................X.........XXXXXXXXXXX.........X...............................................
.......................X........XXXXXXXXXXXXX........X...............................................
.......................X..........XXXXXXXXX..........X...............................................
.....X.................X.........XXXXXXXXXXX.........X...............................................
.......................X........XXXXXXXXXXXXX........X......................................X........
.......................X.......XXXXXXXXXXXXXXX.......X...............................................
...........X...........X......XXXXXXXXXXXXXXXXX......X...............................................
.......................X........XXXXXXXXXXXXX........X...............................X.....X.........
................X.X....X.......XXXXXXXXXXXXXXX.......X..............................X................
.......X...............X......XXXXXXXXXXXXXXXXX......X...............................................
.............X.........X.....XXXXXXXXXXXXXXXXXXX.....X...............................................
......X..X.............X....XXXXXXXXXXXXXXXXXXXXX....X..................................X....X.......
.......................X.............XXX.............X...................X.................X.......X.
.......................X.............XXX.............X...............................................
.......................X.............XXX.............X.......................X..............X........
.......................X.............................X...............................X...............
.......................X.............................X........................X......................
.......................X.............................X.....X.........................................
.......................X.............................X...............................................
.......................XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX...............................................
.....................................................................................................
...................X..X..............................................................................
..............................X..X...................................................................
..................................................X..................................................
.......X..X.............X..X.........................................................................
.................X......X............X.................X......X....................X.................
.....................................................................................................
......................................X..............................................................
.....................................................................................................
X....................................................................................................
...X.............................................................X...................................
............................X........................................................................
.............................................X.........................................X.............
..................................................X......X...........................................
.............................................................................................X..X....
...............................................................X......................X..............
....................................................X................................................
...................................................................................................X.
.......................................X...........................X................X.............X..
...................................................X.................................................
.....................................................................................................
...........................................................X...................................X.....
...........X................................X...............................X........................
........X........................X.......X...........................................................
.............................X........................................................X............X.
............................X........................................................................
.....................................................................................................
......................................................X.....X........................................
.....................................................................................................
..........X.....................................................................X........X..........X
............................................................X........................................
.........X...............................X...........................................................
.....................................................................................................
.X............................................XX.................X...X.X.....................X.......
.....................................................................................................
........X...........................................................X................................
.........................................................X...........................X...............
.............................................................X.......................................
.............................X....X.X.....................X..........................................
...................................................................................X.................
.....................................................................................................
..................................................................................X..................
........................................................................................X............
..............................................................X......................................
...X..............X..................................................................................
        */
    }
    7505
}
